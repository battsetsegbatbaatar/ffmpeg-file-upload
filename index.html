<!DOCTYPE html>
<html lang="mn">
  <head>
    <meta charset="UTF-8" />
    <title>üé• –í–∏–¥–µ–æ Upload & –•”©—Ä–≤“Ø“Ø–ª—ç–ª—Ç</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 700px;
        margin: 40px auto;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 10px;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .upload-block {
        background: #fff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      input[type='file'] {
        width: 100%;
        margin-bottom: 10px;
      }
      button {
        padding: 10px 20px;
        background-color: #0077cc;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .result {
        margin-top: 10px;
        font-weight: bold;
        color: #333;
      }
      select {
        margin-top: 10px;
        width: 100%;
        display: block;
      }
      video {
        margin-top: 10px;
        width: 100%;
        height: auto;
        border-radius: 8px;
        background: black;
      }
    </style>

    <!-- HLS.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  </head>
  <body>
    <h1>üì§ 4 –í–∏–¥–µ–æ Upload & –•”©—Ä–≤“Ø“Ø–ª—ç–ª—Ç</h1>

    <div
      class="upload-block"
      style="display: flex; flex-direction: column; justify-content: center"
    >
      <h3>üîê –ù—ç–≤—Ç—Ä—ç—Ö</h3>
      <form id="token">
        <input
          style="width: 75%; margin-left: 10px; padding: 7px"
          name="token"
          placeholder="token"
          required
        />

        <button type="submit">üîë –ù—ç–≤—Ç—Ä—ç—Ö</button>
      </form>
    </div>

    <div id="app">
      <div
        class="upload-block"
        id="upload0"
      >
        <form onsubmit="handleSubmit(event, 0)">
          <input
            type="file"
            accept="video/*"
            required
            onchange="handleFileChange(event, 0)"
          />
          <button type="submit">üìÅ Upload & Convert</button>
          <div
            class="result"
            id="result0"
          ></div>

          <div
            id="playerContainer0"
            style="display: none"
          >
            <label>üéöÔ∏è –°–æ–Ω–≥–æ–ª—Ç:</label>
            <select
              id="select0"
              onchange="changeVideoSource(0)"
            ></select>
            <video
              id="video0"
              controls
              autoplay
              playsinline
            ></video>
          </div>
        </form>
      </div>

      <div
        class="upload-block"
        id="upload1"
      >
        <form onsubmit="handleSubmit(event, 1)">
          <input
            type="file"
            accept="video/*"
            required
            onchange="handleFileChange(event, 1)"
          />
          <button type="submit">üìÅ Upload & Convert</button>
          <div
            class="result"
            id="result1"
          ></div>

          <div
            id="playerContainer1"
            style="display: none"
          >
            <label>üéöÔ∏è –°–æ–Ω–≥–æ–ª—Ç:</label>
            <select
              id="select1"
              onchange="changeVideoSource(1)"
            ></select>
            <video
              id="video1"
              controls
              autoplay
              playsinline
            ></video>
          </div>
        </form>
      </div>

      <div
        class="upload-block"
        id="upload2"
      >
        <form onsubmit="handleSubmit(event, 2)">
          <input
            type="file"
            accept="video/*"
            required
            onchange="handleFileChange(event, 2)"
          />
          <button type="submit">üìÅ Upload & Convert</button>
          <div
            class="result"
            id="result2"
          ></div>

          <div
            id="playerContainer2"
            style="display: none"
          >
            <label>üéöÔ∏è –°–æ–Ω–≥–æ–ª—Ç:</label>
            <select
              id="select2"
              onchange="changeVideoSource(2)"
            ></select>
            <video
              id="video2"
              controls
              autoplay
              playsinline
            ></video>
          </div>
        </form>
      </div>

      <div
        class="upload-block"
        id="upload3"
      >
        <form onsubmit="handleSubmit(event, 3)">
          <input
            type="file"
            accept="video/*"
            required
            onchange="handleFileChange(event, 3)"
          />
          <button type="submit">üìÅ Upload & Convert</button>
          <div
            class="result"
            id="result3"
          ></div>

          <div
            id="playerContainer3"
            style="display: none"
          >
            <label>üéöÔ∏è –°–æ–Ω–≥–æ–ª—Ç:</label>
            <select
              id="select3"
              onchange="changeVideoSource(3)"
            ></select>
            <video
              id="video3"
              controls
              autoplay
              playsinline
            ></video>
          </div>
        </form>
      </div>
    </div>
    <form id="deleteForm">
      <input
        name="id"
        placeholder="–§–∞–π–ª—ã–Ω key"
        required
      />
      <button type="submit">Delete Video</button>
    </form>

    <script>
      document.getElementById('token').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const token = fd.get('token');
        if (!token) {
          alert(data.message || '–ê–º–∂–∏–ª—Ç–≥“Ø–π.');
        }
        localStorage.setItem('token', token);
        alert('–ù—ç–≤—Ç—Ä—ç–ª—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π!');
      });
    </script>

    <script>
      document
        .getElementById('deleteForm')
        .addEventListener('submit', async function (e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const id = formData.get('id');

          const response = await fetch('/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
          });

          const result = await response.json();
          alert(result.message || 'Something happened');
        });
    </script>

    <script>
      const files = [null, null, null, null];
      const jobIntervals = [null, null, null, null];
      const outputsData = [[], [], [], []];
      const hlsInstances = [null, null, null, null];

      function handleFileChange(e, idx) {
        files[idx] = e.target.files[0];
      }

      async function handleSubmit(e, idx) {
        e.preventDefault();
        if (!files[idx]) {
          alert('üìÇ –§–∞–π–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É!');
          return;
        }

        const resultDiv = document.getElementById(`result${idx}`);
        resultDiv.textContent = '‚è≥ Upload —Ö–∏–π–∂ –±–∞–π–Ω–∞...';

        const formData = new FormData();
        formData.append('video', files[idx]);

        try {
          const res = await fetch('/upload', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();

          if (data.jobId) {
            resultDiv.textContent = `üì§ Upload –∞–º–∂–∏–ª—Ç—Ç–∞–π. Job ID: ${data.jobId}`;
            pollJobStatus(idx, data.jobId);
          } else if (data.error) {
            resultDiv.textContent = `‚ùå –ê–ª–¥–∞–∞: ${data.error}`;
          }
        } catch (err) {
          console.error(err);
          resultDiv.textContent = '‚ùå Upload –∞–º–∂–∏–ª—Ç–≥“Ø–π –±–æ–ª–ª–æ–æ.';
        }
      }

      function pollJobStatus(idx, jobId) {
        if (jobIntervals[idx]) clearInterval(jobIntervals[idx]);

        jobIntervals[idx] = setInterval(async () => {
          const resultDiv = document.getElementById(`result${idx}`);
          try {
            const res = await fetch(`/job/${jobId}/result`);
            const data = await res.json();

            if (data.status === '‚úÖ –•—É–≤–∏—Ä–≥–∞—Å–∞–Ω') {
              clearInterval(jobIntervals[idx]);
              resultDiv.textContent = '‚úÖ –í–∏–¥–µ–æ –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö—É–≤–∏—Ä–≥–∞–ª–∞–∞!';

              if (data.outputs && data.outputs.data) {
                const videoData = Array.isArray(data.outputs.data)
                  ? data.outputs.data
                  : [data.outputs.data];

                outputsData[idx] = videoData;
                setupPlayer(idx);
              } else {
                resultDiv.textContent = '‚úÖ –•—É–≤–∏—Ä–≥–∞—Å–∞–Ω —á –≤–∏–¥–µ–æ –ª–∏–Ω–∫ –æ–ª–¥—Å–æ–Ω–≥“Ø–π.';
              }
            } else if (data.status?.startsWith?.('‚ùå')) {
              clearInterval(jobIntervals[idx]);
              resultDiv.textContent = `‚ùå –ê–ª–¥–∞–∞: ${
                data.reason || '–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π'
              }`;
            } else {
              resultDiv.textContent = `‚è≥ –•“Ø–ª—ç—ç–∂ –±–∞–π–Ω–∞: ${data.status}`;
            }
          } catch (err) {
            clearInterval(jobIntervals[idx]);
            resultDiv.textContent = '‚ùå –ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.';
            console.error(err);
          }
        }, 2000);
      }

      function getBestUrl(videoObj) {
        if (videoObj.url && videoObj.url.trim() !== '') return videoObj.url;

        const qualities = ['p1080', 'p720', 'p480', 'p360'];
        for (const q of qualities) {
          if (videoObj[q]) return videoObj[q];
        }
        return null;
      }

      function setupPlayer(idx) {
        const playerContainer = document.getElementById(
          `playerContainer${idx}`
        );
        const select = document.getElementById(`select${idx}`);
        const video = document.getElementById(`video${idx}`);

        if (!outputsData[idx] || outputsData[idx].length === 0) {
          console.warn('outputsData —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞:', idx);
          return;
        }

        const videoObj = outputsData[idx][0];

        let options = '';

        if (videoObj.url && videoObj.url.trim() !== '') {
          options += `<option value="${videoObj.url}">default url</option>`;
        }

        const qualities = ['p1080', 'p720', 'p480', 'p360'];
        qualities.forEach((q) => {
          if (videoObj[q]) {
            options += `<option value="${videoObj[q]}">${q}</option>`;
          }
        });

        if (!options) {
          if (videoObj.p720) {
            options = `<option value="${videoObj.p720}">p720</option>`;
          } else {
            console.error('Video-–¥ —Ç–æ—Ö–∏—Ä–æ—Ö URL –∞–ª–≥–∞:', videoObj);
            return;
          }
        }

        select.innerHTML = options;
        playerContainer.style.display = 'block';

        select.value = getBestUrl(videoObj);

        changeVideoSource(idx);
      }

      function changeVideoSource(idx) {
        const select = document.getElementById(`select${idx}`);
        const video = document.getElementById(`video${idx}`);
        const url = select.value;

        if (hlsInstances[idx]) {
          hlsInstances[idx].destroy();
          hlsInstances[idx] = null;
        }

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.play().catch(() => {});
          });
          hlsInstances[idx] = hls;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.play().catch(() => {});
        } else {
          alert('–¢–∞–Ω—ã –±—Ä–∞—É–∑–µ—Ä HLS –≤–∏–¥–µ–æ —Ç–æ–≥–ª—É—É–ª–∞—Ö –¥—ç–º–∂–ª—ç–≥–≥“Ø–π –±–∞–π–Ω–∞.');
        }
      }
    </script>
  </body>
</html>
